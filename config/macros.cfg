[gcode_macro START_PRINT]
# Для OrcaSlicer START_PRINT EXTRUDER_TEMP=[nozzle_temperature_initial_layer] BED_TEMP=[bed_temperature_initial_layer_single]
# Для Cura: START_PRINT EXTRUDER_TEMP={material_print_temperature_layer_0} BED_TEMP={material_bed_temperature_layer_0}
description: START_PRINT EXTRUDER_TEMP=extruder_temp BED_TEMP=bed_temp
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(235)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}
    BEEP P=100
    CLEAR_PAUSE
    M220 S100                                                          # Сброс скорости до дефолтной 100%
    M221 S100                                                          # Сброс потока до дефолтного 100%
    G90                                                                # Absolute positioning
    M82                                                                # Absolute extrusion mode
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}         # Установить температуру нагрева стола
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp * 0.90}       # Ждать нагрев стола до 90% от заданнй температуры
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp}      # Установить температуру сопла                                                         # 
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp}              # Ждать нагрев стола до заданнй температуры
    BEEP P=100 N=2
    M106 S255                                                          # Включить вентилятор обдува
    G28
    BED_MESH_CALIBRATE
    M107                                                               # Выключить вентилятор обдува
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}           # Ждать нагрев сопла до заданнй температуры
    G0 Z10 F600
    G92 E0
    BEEP P=250

# Макрос завершения печати с выключением принтера после остывания сопла до заданной температуры
[gcode_macro END_PRINT]
description: END_PRINT MAX_EXTRUDER_TEMP=extruder_temp
gcode:
    M400                                                               # Ждать очищения буфера
    {% set extruder_temp = params.MAX_EXTRUDER_TEMP|default(60)|float %}
    BEEP P=100 N=3
    TURN_OFF_HEATERS
    G1 E-1 F1500
    SAVE_GCODE_STATE NAME=lifting_the_nozzle
    G91
    G0 Z1 F600
    RESTORE_GCODE_STATE NAME=lifting_the_nozzle
    PARK X=0 Y=0 Z=180
    M106 S255                                                          # Включить вентилятор обдува
    M84
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={extruder_temp}           # Ждать остывание сопла до заданнй температуры
    M107                                                               # Выключить вентилятор обдува
    PW_OFF_PRINTER P=60                                                # Выключить принтер с задержкой

[gcode_macro PARK]
description: Парковка
gcode:
    {% set x_park = params.X|default(0)|float %}
    {% set y_park = params.Y|default(0)|float %}
    {% set z_park = params.Z|default(10)|float + printer.toolhead.position.z|float %}
    {% set x_max = printer.toolhead.axis_maximum.x|float %}
    {% set y_max = printer.toolhead.axis_maximum.y|float %}
    {% set z_max = (printer.toolhead.axis_maximum.z|float - 10) %}
    {% if x_park > x_max %}
        {% set x_park = x_max %}
    {% endif %}
    {% if y_park > y_max %}
        {% set y_park = y_max %}
    {% endif %}
    {% if z_park > z_max %}
        {% set z_park = z_max %}
    {% endif %}
    SAVE_GCODE_STATE NAME=park_state
    G90
    G0 X{x_park} Y{y_park} F3000
    G0 Z{z_park} F600
    RESTORE_GCODE_STATE NAME=park_state

[gcode_macro FILAMENT_CHANGE]
description: Сменить филамент
gcode:
    SAVE_GCODE_STATE NAME=FILAMENT_CHANGE_STATE
    {% set timer = params.T|default(300)|float %}
    {% set unload = params.U|default(80)|float %}
    {% set load = params.L|default(80)|float %}
    {% if printer.pause_resume.is_paused %}
        M118 Already paused
    {% else %}
        {% if printer.toolhead.homed_axes != "xyz" %}
            M118 Homing
            G28                                                           # home if not homed
        {% else %}
            M118 Pausing print
            PAUSE
        {% endif %}
    {% endif %}
    M118 Changing filament
    SET_IDLE_TIMEOUT TIMEOUT=7200
    FILAMENT_UNLOAD U={unload}                                            # макрос FILAMENT_UNLOAD выгружает филамент
    COUNTDOWN TIME={timer} MSG="Change filament! Time left: "             # макрос COUNTDOWN ожидает 5 минут
    FILAMENT_LOAD L={load}                                                # макрос FILAMENT_LOAD загружает филамент
    RESTORE_GCODE_STATE NAME=FILAMENT_CHANGE_STATE
    {% if printer.pause_resume.is_paused %}
        M118 Resuming print
        RESUME
    {% endif %}

[gcode_macro FILAMENT_LOAD]
description: Загрузить филамент
gcode:
    {% set load = params.L|default(80)|float * 0.4 %}
    {% set extruder_temp = params.T|default(240)|float %}
    SAVE_GCODE_STATE NAME=FILAMENT_LOAD_STATE
    LOW_TEMP_CHECK T={extruder_temp}
    M118 Loading filament
    M83                                                                   # relative extrusion
    G1 E{load} F500                                                      # extrude fast
    G4 P1000                                                              # wait 1 second
    G1 E{load} F200                                                       # extrude slow
    RESTORE_GCODE_STATE NAME=FILAMENT_LOAD_STATE

[gcode_macro FILAMENT_UNLOAD]
description: Выгрузить филамент
gcode:
    {% set unload = params.U|default(80)|float %}
    {% set extruder_temp = params.T|default(230)|float %}
    SAVE_GCODE_STATE NAME=FILAMENT_UNLOAD_STATE
    LOW_TEMP_CHECK T={extruder_temp}
    M118 Unloading filament
    M83                                                                   # relative extrusion
    G1 E2  F200                                                           # extrude a little
    G1 E-10  F200                                                         # retract a little
    G1 E-{unload} F500                                                   # retract a lot
    RESTORE_GCODE_STATE NAME=FILAMENT_UNLOAD_STATE

[gcode_macro LOW_TEMP_CHECK]
description: Проверка температуры сопла
gcode:
    {% set extruder_temp = params.T|default(235)|float %}
    {% if printer.extruder.target > extruder_temp %}                      # if there is a setpoint for extruder
        {% set extruder_temp = printer.extruder.target %}
    {% endif %}
    {% if printer.extruder.temperature < extruder_temp %}                 # heat to the target
        M118 Heating to {extruder_temp}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}
    {% endif %}

[gcode_macro COUNTDOWN]
gcode:
    {% set timer = params.TIME|default(10)|int %}
    {% set message = params.MSG|default("Time: ") %}
    # countdown
    {% if timer > 60 %}
        {% for s in range(timer, 60, -10) %}
            M118 {message} {s}s
            G4 P10000                                                     # dwell 10 seconds
        {% endfor %}
        {% set timer = 60 %}
    {% endif %}
    {% if timer > 10 %}
        {% for s in range(timer, 10, -5) %}
            M118 {message} {s}s
            G4 P5000                                                      # dwell 5 seconds
        {% endfor %}
        {% set timer = 10 %}
    {% endif %}
    {% if timer > 0 %}
        {% for s in range(timer, 0, -1) %}
            M118 {message} {s}s
            G4 P1000                                                      # dwell 1 second
        {% endfor %}
    {% endif %}

[gcode_macro PRIME_LINE]
description: Напечатать первую линию
gcode:
    {% set feedrate = params.F|default(20)|float * 60 %}
    {% set length = 100.0 %}
    {% set width = printer.configfile.settings.extruder.nozzle_diameter|float %}
    {% set height = ( (width / 0.04)|int - (width / 0.04 / 4)|int )|float * 0.04 %}
    {% set extrude = length * width * height / 1.6 %}
    SAVE_GCODE_STATE NAME=PRIME_LINE_STATE
    {% if 'Y' in params %}
        {% set x_start = 5.0 %}
        {% set y_start = (printer.toolhead.axis_maximum.y|float - 100) / 2 %}
        G0 X{x_start} Y{y_start} F5000                                                   # move to start position
        G0 Z{height} F800
        G91                                                                              # relative positioning
        G1 Y100 E{extrude} F{feedrate}                                                   # draw the 1st line
        G0 X{width} F5000                                                                # move to the next line
        G1 Y-100 E{extrude} F{feedrate}                                                  # draw the 2nd line
    {% else %}
        {% set x_start = (printer.toolhead.axis_maximum.x|float - 100) / 2 %}
        {% set y_start = 5.0 %}
        G0 X{x_start} Y{y_start} F5000                                                   # move to start position
        G0 Z{height} F800
        G91                                                                              # relative positioning
        G1 E4 F{feedrate}                                                                # prime
        G1 X100 E{extrude} F{feedrate}                                                   # draw the 1st line
        G0 Y{width} F5000                                                                # move to the next line
        G1 X-100 E{extrude} F{feedrate}                                                  # draw the 2nd line
    {% endif %}
    RESTORE_GCODE_STATE NAME=PRIME_LINE_STATE
    
# Выключить блок питания принтера c задержкой
[gcode_macro PW_OFF_PRINTER] 
description: PW_OFF_PRINTER P=duration
gcode:
    {% set duration = params.P|default(10)|int %}
    G4 P{duration*1000}
    {action_respond_info("!! Power OFF !!")}
    SET_PIN PIN=PW_OFF VALUE=0

[gcode_macro BUTTON_PW_OFF]
description: Обработка нажатия кнопки Power OFF более 2-х секунд
variable_last_press: 0.0
gcode:
    {action_respond_info("Выключение принтера кнопкой Power OFF")}
    PW_OFF_PRINTER P=1

# Формирование звукового сигнала определенной длительности и количеством повторений 
[gcode_macro BEEP]
description: BEEP P=duration N=quantity
gcode:
    {% set duration = params.P|default(250)|int %}
    {% set quantity = params.N|default(1)|int %}
    {% for m in range(quantity) %}
      SET_PIN PIN=BEEPER VALUE=1
      G4 P{duration}
      SET_PIN PIN=BEEPER VALUE=0
      G4 P50
    {% endfor %}

# Обработка команды выбора инструмента для слайсера Cura
[gcode_macro T0]
description:
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder

[gcode_macro M600]
description: Замена филамента
gcode:
    FILAMENT_CHANGE

[gcode_macro M601]
description: Замена филамента
gcode:
    FILAMENT_CHANGE

[gcode_macro M701] 
description: Загрузить филамент
gcode:
    FILAMENT_LOAD

[gcode_macro M702]
description: Выгрузить филамент
gcode:
    FILAMENT_UNLOAD

[gcode_macro M900]
description: Установить значение Linear Advance
gcode:
    {% if 'K' in params %}
        SET_PRESSURE_ADVANCE ADVANCE={ params.K|float }
    {% endif %}